1. DetachedInstanceError with SQLAlchemy (Instance <AIRule> is not bound to a Session)
Affected tests:

test_events_ai.py::test_event_triggers_ai_and_notify_log
test_logs_and_chatbot.py::test_logs_visibility_and_chatbot_endpoints
Other event/chatbot-related code using AIRule objects
Cause:
You're trying to access a property or reload an object that is no longer attached to an active SQLAlchemy session. This happens if you query an object, then let its session close or expire, and try to access lazy-loaded attributes or use it in new queries.

Solution:

Make sure all ORM objects you want to use are attached to an active session when you access them.
If extracting objects in one context and passing to another, re-associate them with an active session, or re-query using the session before use.
Example fix:
Where ai_rule is used after its session is closed, do:

Python
# Re-query the object if necessary before use
ai_rule = session.query(AIRule).get(ai_rule.id)
# Now access its attributes safely
Or, if returning objects from a function, return their IDs and re-fetch them where needed.

Go through places in your event and chatbot endpoints/services where AIRule or similar objects are returned, saved, or passed between session scopes, and ensure session context is preserved.

2. Invalid Keyword Argument on Model (TypeError: 'suggested_severity' is an invalid keyword argument for AIFeedback)
Affected test:

tests/test_ai_rules_feedback.py::test_ai_rules_crud_admin_only_and_feedback
Cause:
You are trying to instantiate the AIFeedback model with a keyword argument suggested_severity that is not defined on the model.

Solution:

Update the definition of AIFeedback to include suggested_severity if it's needed.
Or, remove/replace suggested_severity in the part of your code/test where you create AIFeedback objects if not needed.
Example fix:
If you want this field:

Python
class AIFeedback(Base):
    # ... existing fields ...
    suggested_severity = Column(String)
If unnecessary, remove the argument:

Python
feedback = AIFeedback(some_field=x, other_field=y)  # Remove suggested_severity
Check the instantiation in your CRUD feedback logic and tests.

Next Steps
Fix the session management for your SQLAlchemy models where you use them outside their active session.
Update your model instantiations to match your actual database model properties.
Re-run your tests after these fixes.